<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Gas and Fees | MetaOS Docs</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/docs/favicon.ico">
    <link rel="manifest" href="/docs/manifest.json">
    <link rel="apple-touch-icon" href="/docs/icons/apple-touch-icon-152x152.png">
    <link rel="mask-icon" href="/docs/icons/safari-pinned-tab.svg" color="#732ad2">
    <meta name="description" content="Developer documentation for the MetaOS">
    <meta name="theme-color" content="#732ad2">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/icons/msapplication-icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    <link rel="preload" href="/docs/assets/css/0.styles.9f4aaddc.css" as="style"><link rel="preload" href="/docs/assets/js/app.4c002d4e.js" as="script"><link rel="preload" href="/docs/assets/js/3.6a5372a7.js" as="script"><link rel="preload" href="/docs/assets/js/11.d2336c4a.js" as="script"><link rel="preload" href="/docs/assets/js/4.dad8f1e2.js" as="script"><link rel="prefetch" href="/docs/assets/js/10.a13577f4.js"><link rel="prefetch" href="/docs/assets/js/12.481e56ea.js"><link rel="prefetch" href="/docs/assets/js/13.8cd42a12.js"><link rel="prefetch" href="/docs/assets/js/14.22839b7c.js"><link rel="prefetch" href="/docs/assets/js/15.f112457b.js"><link rel="prefetch" href="/docs/assets/js/16.89f97260.js"><link rel="prefetch" href="/docs/assets/js/17.5c101dfb.js"><link rel="prefetch" href="/docs/assets/js/18.3250cd7c.js"><link rel="prefetch" href="/docs/assets/js/19.3f60a875.js"><link rel="prefetch" href="/docs/assets/js/20.6d044db7.js"><link rel="prefetch" href="/docs/assets/js/21.16fed355.js"><link rel="prefetch" href="/docs/assets/js/22.4f2aecac.js"><link rel="prefetch" href="/docs/assets/js/23.f425d1b8.js"><link rel="prefetch" href="/docs/assets/js/24.0cd1b8f0.js"><link rel="prefetch" href="/docs/assets/js/25.80d8eda5.js"><link rel="prefetch" href="/docs/assets/js/26.7f6f78ec.js"><link rel="prefetch" href="/docs/assets/js/27.3dd05e22.js"><link rel="prefetch" href="/docs/assets/js/28.a0f41712.js"><link rel="prefetch" href="/docs/assets/js/29.705c8702.js"><link rel="prefetch" href="/docs/assets/js/30.73e3b02b.js"><link rel="prefetch" href="/docs/assets/js/31.49b171ba.js"><link rel="prefetch" href="/docs/assets/js/5.868ccc2e.js"><link rel="prefetch" href="/docs/assets/js/6.53bd7877.js"><link rel="prefetch" href="/docs/assets/js/7.d74dec53.js"><link rel="prefetch" href="/docs/assets/js/8.f3c5c757.js"><link rel="prefetch" href="/docs/assets/js/9.6a681094.js"><link rel="prefetch" href="/docs/assets/js/vendors~docsearch.f68603d6.js">
    <link rel="stylesheet" href="/docs/assets/css/0.styles.9f4aaddc.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/docs/en/" class="home-link router-link-active"><img src="/docs/favicon.ico" alt="MetaOS Docs" class="logo"> <span class="site-name can-hide">MetaOS Docs</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/meteos-labs/metaos-docs" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/meteos-labs/metaos-docs" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>ABOUT MetaOS</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/en/" aria-current="page" class="sidebar-link">Introduction</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>For Web3 User</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>Basic Concepts</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/en/for_web3_user/transactions.html" class="sidebar-link">Transactions</a></li><li><a href="/docs/en/for_web3_user/tokens.html" class="sidebar-link">Tokens</a></li><li><a href="/docs/en/for_web3_user/gas-and-fees.html" aria-current="page" class="active sidebar-link">Gas and Fees</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Digital Wallets</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Account Keys</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Tool</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>For Web3 Developer</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/en/test21.html" class="sidebar-link">Test2-1</a></li><li><a href="/docs/en/test22.html" class="sidebar-link">Test2-2</a></li><li><a href="/docs/en/test23.html" class="sidebar-link">Test2-3</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>For Validator&amp;Delegators</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/en/test21.html" class="sidebar-link">Test2-1</a></li><li><a href="/docs/en/test22.html" class="sidebar-link">Test2-2</a></li><li><a href="/docs/en/test23.html" class="sidebar-link">Test2-3</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="gas-and-fees"><a href="#gas-and-fees" class="header-anchor">#</a> Gas and Fees</h1> <p>The concept of Gas represents the amount of computational effort required to execute specific operations on the state machine.</p> <p>Gas was created on Ethereum to disallow the EVM (Ethereum Virtual Machine) from running infinite loops by allocating a small amount of monetary value into the system. A unit of gas, usually in the form of a fraction of the native coin, is consumed for every operation on the EVM and requires a user to pay for these operations. These operations consist in state transitions such as sending a transaction or calling a contract.</p> <p>Exactly like Ethereum, Cosmos utilizes the concept of gas and this is how Cosmos tracks the resource usage of operations during execution. Operations on Cosmos are represented as read or writes done to the chain's store.</p> <p>In Cosmos, a fee is calculated and charged to the user during a message execution. This fee is calculated from the sum of all gas consumed in a message execution. So, the fee is equivalent to the gas multiplied by the gas price.</p> <p>In both networks, gas is used to make sure that operations do not require an excess amount of computational power to complete and as a way to deter bad-acting users from spamming the network.</p> <h3 id="cosmos-gas"><a href="#cosmos-gas" class="header-anchor">#</a> Cosmos Gas</h3> <p>In the Cosmos SDK, gas is tracked in the main GasMeter and the BlockGasMeter:</p> <ul><li>GasMeter: keeps track of the gas consumed during executions that lead to state transitions. It is reset on every transaction execution.</li> <li>BlockGasMeter: keeps track of the gas consumed in a block and enforces that the gas does not go over a predefined limit. This limit is defined in the Tendermint consensus parameters and can be changed via governance parameter change proposals.
More information regarding gas in Cosmos SDK can be found <a href="https://docs.cosmos.network/main/basics/gas-fees.html" target="_blank" rel="noopener noreferrer">here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</li></ul> <h3 id="matching-evm-gas-consumption"><a href="#matching-evm-gas-consumption" class="header-anchor">#</a> Matching EVM Gas consumption</h3> <p>Evmos is an EVM-compatible chain that supports Ethereum Web3 tooling. For this reason, gas consumption must be equitable with other EVMs, most importantly Ethereum.</p> <p>The main difference between EVM and Cosmos state transitions, is that the EVM uses a <a href="https://github.com/ethereum/go-ethereum/blob/master/params/protocol_params.go" target="_blank" rel="noopener noreferrer">gas table<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>for each OPCODE, whereas Cosmos uses a GasConfig that charges gas for each CRUD operation by setting a flat and per-byte cost for accessing the database.</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// GasConfig defines gas cost for each operation on KVStores</span>
<span class="token keyword">type</span> GasConfig <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	HasCost          Gas
	DeleteCost       Gas
	ReadCostFlat     Gas
	ReadCostPerByte  Gas
	WriteCostFlat    Gas
	WriteCostPerByte Gas
	IterNextCostFlat Gas
<span class="token punctuation">}</span>
</code></pre></div><p>In order to match the gas consumed by the EVM, the gas consumption logic from the SDK is ignored, and instead the gas consumed is calculated by subtracting the state transition leftover gas plus refund from the gas limit defined on the message.</p> <p>To ignore the SDK gas consumption, we reset the transaction <code>GasMeter</code> count to 0 and manually set it to the <code>gasUsed</code> value computed by the EVM module at the end of the execution.</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> keeper
<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;math/big&quot;</span>
	<span class="token string">&quot;os&quot;</span>
	<span class="token string">&quot;time&quot;</span>
	<span class="token string">&quot;github.com/palantir/stacktrace&quot;</span>
	tmtypes <span class="token string">&quot;github.com/tendermint/tendermint/types&quot;</span>
	<span class="token string">&quot;github.com/cosmos/cosmos-sdk/telemetry&quot;</span>
	sdk <span class="token string">&quot;github.com/cosmos/cosmos-sdk/types&quot;</span>
	sdkerrors <span class="token string">&quot;github.com/cosmos/cosmos-sdk/types/errors&quot;</span>
	authtypes <span class="token string">&quot;github.com/cosmos/cosmos-sdk/x/auth/types&quot;</span>
	stakingtypes <span class="token string">&quot;github.com/cosmos/cosmos-sdk/x/staking/types&quot;</span>
	ethermint <span class="token string">&quot;github.com/tharsis/ethermint/types&quot;</span>
	<span class="token string">&quot;github.com/tharsis/ethermint/x/evm/types&quot;</span>
	<span class="token string">&quot;github.com/ethereum/go-ethereum/common&quot;</span>
	<span class="token string">&quot;github.com/ethereum/go-ethereum/core&quot;</span>
	ethtypes <span class="token string">&quot;github.com/ethereum/go-ethereum/core/types&quot;</span>
	<span class="token string">&quot;github.com/ethereum/go-ethereum/core/vm&quot;</span>
	<span class="token string">&quot;github.com/ethereum/go-ethereum/params&quot;</span>
<span class="token punctuation">)</span>
<span class="token comment">// NewEVM generates a go-ethereum VM from the provided Message fields and the chain parameters</span>
<span class="token comment">// (ChainConfig and module Params). It additionally sets the validator operator address as the</span>
<span class="token comment">// coinbase address to make it available for the COINBASE opcode, even though there is no</span>
<span class="token comment">// beneficiary of the coinbase transaction (since we're not mining).</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>k <span class="token operator">*</span>Keeper<span class="token punctuation">)</span> <span class="token function">NewEVM</span><span class="token punctuation">(</span>msg core<span class="token punctuation">.</span>Message<span class="token punctuation">,</span> config <span class="token operator">*</span>params<span class="token punctuation">.</span>ChainConfig<span class="token punctuation">,</span> params types<span class="token punctuation">.</span>Params<span class="token punctuation">,</span> coinbase common<span class="token punctuation">.</span>Address<span class="token punctuation">)</span> <span class="token operator">*</span>vm<span class="token punctuation">.</span>EVM <span class="token punctuation">{</span>
	blockCtx <span class="token operator">:=</span> vm<span class="token punctuation">.</span>BlockContext<span class="token punctuation">{</span>
		CanTransfer<span class="token punctuation">:</span> core<span class="token punctuation">.</span>CanTransfer<span class="token punctuation">,</span>
		Transfer<span class="token punctuation">:</span>    core<span class="token punctuation">.</span>Transfer<span class="token punctuation">,</span>
		GetHash<span class="token punctuation">:</span>     k<span class="token punctuation">.</span><span class="token function">GetHashFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		Coinbase<span class="token punctuation">:</span>    coinbase<span class="token punctuation">,</span>
		GasLimit<span class="token punctuation">:</span>    ethermint<span class="token punctuation">.</span><span class="token function">BlockGasLimit</span><span class="token punctuation">(</span>k<span class="token punctuation">.</span>ctx<span class="token punctuation">)</span><span class="token punctuation">,</span>
		BlockNumber<span class="token punctuation">:</span> big<span class="token punctuation">.</span><span class="token function">NewInt</span><span class="token punctuation">(</span>k<span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">BlockHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		Time<span class="token punctuation">:</span>        big<span class="token punctuation">.</span><span class="token function">NewInt</span><span class="token punctuation">(</span>k<span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">BlockHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Time<span class="token punctuation">.</span><span class="token function">Unix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		Difficulty<span class="token punctuation">:</span>  big<span class="token punctuation">.</span><span class="token function">NewInt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// unused. Only required in PoW context</span>
	<span class="token punctuation">}</span>
	txCtx <span class="token operator">:=</span> core<span class="token punctuation">.</span><span class="token function">NewEVMTxContext</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
	vmConfig <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token function">VMConfig</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span>
	<span class="token keyword">return</span> vm<span class="token punctuation">.</span><span class="token function">NewEVM</span><span class="token punctuation">(</span>blockCtx<span class="token punctuation">,</span> txCtx<span class="token punctuation">,</span> k<span class="token punctuation">,</span> config<span class="token punctuation">,</span> vmConfig<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// VMConfig creates an EVM configuration from the debug setting and the extra EIPs enabled on the</span>
<span class="token comment">// module parameters. The config generated uses the default JumpTable from the EVM.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>k Keeper<span class="token punctuation">)</span> <span class="token function">VMConfig</span><span class="token punctuation">(</span>params types<span class="token punctuation">.</span>Params<span class="token punctuation">)</span> vm<span class="token punctuation">.</span>Config <span class="token punctuation">{</span>
	<span class="token keyword">return</span> vm<span class="token punctuation">.</span>Config<span class="token punctuation">{</span>
		Debug<span class="token punctuation">:</span>       k<span class="token punctuation">.</span>debug<span class="token punctuation">,</span>
		Tracer<span class="token punctuation">:</span>      vm<span class="token punctuation">.</span><span class="token function">NewJSONLogger</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>vm<span class="token punctuation">.</span>LogConfig<span class="token punctuation">{</span>Debug<span class="token punctuation">:</span> k<span class="token punctuation">.</span>debug<span class="token punctuation">}</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span>Stderr<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// TODO: consider using the Struct Logger too</span>
		NoRecursion<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>                                                      <span class="token comment">// TODO: consider disabling recursion though params</span>
		ExtraEips<span class="token punctuation">:</span>   params<span class="token punctuation">.</span><span class="token function">EIPs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// GetHashFn implements vm.GetHashFunc for Ethermint. It handles 3 cases:</span>
<span class="token comment">//  1. The requested height matches the current height from context (and thus same epoch number)</span>
<span class="token comment">//  2. The requested height is from an previous height from the same chain epoch</span>
<span class="token comment">//  3. The requested height is from a height greater than the latest one</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>k Keeper<span class="token punctuation">)</span> <span class="token function">GetHashFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> vm<span class="token punctuation">.</span>GetHashFunc <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>height <span class="token builtin">uint64</span><span class="token punctuation">)</span> common<span class="token punctuation">.</span>Hash <span class="token punctuation">{</span>
		h <span class="token operator">:=</span> <span class="token function">int64</span><span class="token punctuation">(</span>height<span class="token punctuation">)</span>
		<span class="token keyword">switch</span> <span class="token punctuation">{</span>
		<span class="token keyword">case</span> k<span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">BlockHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> h<span class="token punctuation">:</span>
			<span class="token comment">// Case 1: The requested height matches the one from the context so we can retrieve the header</span>
			<span class="token comment">// hash directly from the context.</span>
			<span class="token comment">// Note: The headerHash is only set at begin block, it will be nil in case of a query context</span>
			headerHash <span class="token operator">:=</span> k<span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">HeaderHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>headerHash<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> common<span class="token punctuation">.</span><span class="token function">BytesToHash</span><span class="token punctuation">(</span>headerHash<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			<span class="token comment">// only recompute the hash if not set (eg: checkTxState)</span>
			contextBlockHeader <span class="token operator">:=</span> k<span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">BlockHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			header<span class="token punctuation">,</span> err <span class="token operator">:=</span> tmtypes<span class="token punctuation">.</span><span class="token function">HeaderFromProto</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>contextBlockHeader<span class="token punctuation">)</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				k<span class="token punctuation">.</span><span class="token function">Logger</span><span class="token punctuation">(</span>k<span class="token punctuation">.</span>ctx<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">&quot;failed to cast tendermint header from proto&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
				<span class="token keyword">return</span> common<span class="token punctuation">.</span>Hash<span class="token punctuation">{</span><span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			headerHash <span class="token operator">=</span> header<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> common<span class="token punctuation">.</span><span class="token function">BytesToHash</span><span class="token punctuation">(</span>headerHash<span class="token punctuation">)</span>
		<span class="token keyword">case</span> k<span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">BlockHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> h<span class="token punctuation">:</span>
			<span class="token comment">// Case 2: if the chain is not the current height we need to retrieve the hash from the store for the</span>
			<span class="token comment">// current chain epoch. This only applies if the current height is greater than the requested height.</span>
			histInfo<span class="token punctuation">,</span> found <span class="token operator">:=</span> k<span class="token punctuation">.</span>stakingKeeper<span class="token punctuation">.</span><span class="token function">GetHistoricalInfo</span><span class="token punctuation">(</span>k<span class="token punctuation">.</span>ctx<span class="token punctuation">,</span> h<span class="token punctuation">)</span>
			<span class="token keyword">if</span> <span class="token operator">!</span>found <span class="token punctuation">{</span>
				k<span class="token punctuation">.</span><span class="token function">Logger</span><span class="token punctuation">(</span>k<span class="token punctuation">.</span>ctx<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">&quot;historical info not found&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;height&quot;</span><span class="token punctuation">,</span> h<span class="token punctuation">)</span>
				<span class="token keyword">return</span> common<span class="token punctuation">.</span>Hash<span class="token punctuation">{</span><span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			header<span class="token punctuation">,</span> err <span class="token operator">:=</span> tmtypes<span class="token punctuation">.</span><span class="token function">HeaderFromProto</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>histInfo<span class="token punctuation">.</span>Header<span class="token punctuation">)</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				k<span class="token punctuation">.</span><span class="token function">Logger</span><span class="token punctuation">(</span>k<span class="token punctuation">.</span>ctx<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">&quot;failed to cast tendermint header from proto&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
				<span class="token keyword">return</span> common<span class="token punctuation">.</span>Hash<span class="token punctuation">{</span><span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">return</span> common<span class="token punctuation">.</span><span class="token function">BytesToHash</span><span class="token punctuation">(</span>header<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">default</span><span class="token punctuation">:</span>
			<span class="token comment">// Case 3: heights greater than the current one returns an empty hash.</span>
			<span class="token keyword">return</span> common<span class="token punctuation">.</span>Hash<span class="token punctuation">{</span><span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// ApplyTransaction runs and attempts to perform a state transition with the given transaction (i.e Message), that will</span>
<span class="token comment">// only be persisted (committed) to the underlying KVStore if the transaction does not fail.</span>
<span class="token comment">//</span>
<span class="token comment">// Gas tracking</span>
<span class="token comment">//</span>
<span class="token comment">// Ethereum consumes gas according to the EVM opcodes instead of general reads and writes to store. Because of this, the</span>
<span class="token comment">// state transition needs to ignore the SDK gas consumption mechanism defined by the GasKVStore and instead consume the</span>
<span class="token comment">// amount of gas used by the VM execution. The amount of gas used is tracked by the EVM and returned in the execution</span>
<span class="token comment">// result.</span>
<span class="token comment">//</span>
<span class="token comment">// Prior to the execution, the starting tx gas meter is saved and replaced with an infinite gas meter in a new context</span>
<span class="token comment">// in order to ignore the SDK gas consumption config values (read, write, has, delete).</span>
<span class="token comment">// After the execution, the gas used from the message execution will be added to the starting gas consumed, taking into</span>
<span class="token comment">// consideration the amount of gas returned. Finally, the context is updated with the EVM gas consumed value prior to</span>
<span class="token comment">// returning.</span>
<span class="token comment">//</span>
<span class="token comment">// For relevant discussion see: https://github.com/cosmos/cosmos-sdk/discussions/9072</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>k <span class="token operator">*</span>Keeper<span class="token punctuation">)</span> <span class="token function">ApplyTransaction</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>ethtypes<span class="token punctuation">.</span>Transaction<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>types<span class="token punctuation">.</span>MsgEthereumTxResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">defer</span> telemetry<span class="token punctuation">.</span><span class="token function">ModuleMeasureSince</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span>ModuleName<span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> types<span class="token punctuation">.</span>MetricKeyTransitionDB<span class="token punctuation">)</span>
	params <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token function">GetParams</span><span class="token punctuation">(</span>k<span class="token punctuation">.</span>ctx<span class="token punctuation">)</span>
	ethCfg <span class="token operator">:=</span> params<span class="token punctuation">.</span>ChainConfig<span class="token punctuation">.</span><span class="token function">EthereumConfig</span><span class="token punctuation">(</span>k<span class="token punctuation">.</span>eip155ChainID<span class="token punctuation">)</span>
	<span class="token comment">// get the latest signer according to the chain rules from the config</span>
	signer <span class="token operator">:=</span> ethtypes<span class="token punctuation">.</span><span class="token function">MakeSigner</span><span class="token punctuation">(</span>ethCfg<span class="token punctuation">,</span> big<span class="token punctuation">.</span><span class="token function">NewInt</span><span class="token punctuation">(</span>k<span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">BlockHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	msg<span class="token punctuation">,</span> err <span class="token operator">:=</span> tx<span class="token punctuation">.</span><span class="token function">AsMessage</span><span class="token punctuation">(</span>signer<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> stacktrace<span class="token punctuation">.</span><span class="token function">Propagate</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">&quot;failed to return ethereum transaction as core message&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// we use a cached context to avoid modifying to state in case EVM msg is reverted</span>
	commit <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token function">BeginCachedContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// get the coinbase address from the block proposer</span>
	coinbase<span class="token punctuation">,</span> err <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token function">GetCoinbaseAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> stacktrace<span class="token punctuation">.</span><span class="token function">Propagate</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">&quot;failed to obtain coinbase address&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// create an ethereum EVM instance and run the message</span>
	evm <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token function">NewEVM</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> ethCfg<span class="token punctuation">,</span> params<span class="token punctuation">,</span> coinbase<span class="token punctuation">)</span>
	txHash <span class="token operator">:=</span> tx<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// set the transaction hash and index to the impermanent (transient) block state so that it's also</span>
	<span class="token comment">// available on the StateDB functions (eg: AddLog)</span>
	k<span class="token punctuation">.</span><span class="token function">SetTxHashTransient</span><span class="token punctuation">(</span>txHash<span class="token punctuation">)</span>
	k<span class="token punctuation">.</span><span class="token function">IncreaseTxIndexTransient</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// pass false to execute in real mode, which do actual gas refunding</span>
	res<span class="token punctuation">,</span> err <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token function">ApplyMessage</span><span class="token punctuation">(</span>evm<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> ethCfg<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> stacktrace<span class="token punctuation">.</span><span class="token function">Propagate</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">&quot;failed to apply ethereum core message&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	res<span class="token punctuation">.</span>Hash <span class="token operator">=</span> txHash<span class="token punctuation">.</span><span class="token function">Hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	logs <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token function">GetTxLogs</span><span class="token punctuation">(</span>txHash<span class="token punctuation">)</span>
	<span class="token comment">// Commit and switch to committed context</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>res<span class="token punctuation">.</span><span class="token function">Failed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	k<span class="token punctuation">.</span><span class="token function">EndCachedContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// Logs needs to be ignored when tx is reverted</span>
	<span class="token comment">// Set the log and bloom filter only when the tx is NOT REVERTED</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>res<span class="token punctuation">.</span><span class="token function">Failed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		res<span class="token punctuation">.</span>Logs <span class="token operator">=</span> types<span class="token punctuation">.</span><span class="token function">NewLogsFromEth</span><span class="token punctuation">(</span>logs<span class="token punctuation">)</span>
		<span class="token comment">// Update block bloom filter in the original context because blockbloom is set in EndBlock</span>
		bloom <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token function">GetBlockBloomTransient</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		bloom<span class="token punctuation">.</span><span class="token function">Or</span><span class="token punctuation">(</span>bloom<span class="token punctuation">,</span> big<span class="token punctuation">.</span><span class="token function">NewInt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">SetBytes</span><span class="token punctuation">(</span>ethtypes<span class="token punctuation">.</span><span class="token function">LogsBloom</span><span class="token punctuation">(</span>logs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		k<span class="token punctuation">.</span><span class="token function">SetBlockBloomTransient</span><span class="token punctuation">(</span>bloom<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// update the gas used after refund</span>
	k<span class="token punctuation">.</span><span class="token function">resetGasMeterAndConsumeGas</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>GasUsed<span class="token punctuation">)</span>
	<span class="token keyword">return</span> res<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
<span class="token comment">// Gas consumption notes (write doc from this)</span>
<span class="token comment">// gas = remaining gas = limit - consumed</span>
<span class="token comment">// Gas consumption in ethereum:</span>
<span class="token comment">// 0. Buy gas -&gt; deduct gasLimit * gasPrice from user account</span>
<span class="token comment">// 		0.1 leftover gas = gas limit</span>
<span class="token comment">// 1. consume intrinsic gas</span>
<span class="token comment">//   1.1 leftover gas = leftover gas - intrinsic gas</span>
<span class="token comment">// 2. Exec vm functions by passing the gas (i.e remaining gas)</span>
<span class="token comment">//   2.1 final leftover gas returned after spending gas from the opcodes jump tables</span>
<span class="token comment">// 3. Refund amount =  max(gasConsumed / 2, gas refund), where gas refund is a local variable</span>
<span class="token comment">// TODO: (@fedekunze) currently we consume the entire gas limit in the ante handler, so if a transaction fails</span>
<span class="token comment">// the amount spent will be grater than the gas spent in an Ethereum tx (i.e here the leftover gas won't be refunded).</span>
<span class="token comment">// ApplyMessage computes the new state by applying the given message against the existing state.</span>
<span class="token comment">// If the message fails, the VM execution error with the reason will be returned to the client</span>
<span class="token comment">// and the transaction won't be committed to the store.</span>
<span class="token comment">//</span>
<span class="token comment">// Reverted state</span>
<span class="token comment">//</span>
<span class="token comment">// The transaction is never &quot;reverted&quot; since there is no snapshot + rollback performed on the StateDB.</span>
<span class="token comment">// Only successful transactions are written to the store during DeliverTx mode.</span>
<span class="token comment">//</span>
<span class="token comment">// Prechecks and Preprocessing</span>
<span class="token comment">//</span>
<span class="token comment">// All relevant state transition prechecks for the MsgEthereumTx are performed on the AnteHandler,</span>
<span class="token comment">// prior to running the transaction against the state. The prechecks run are the following:</span>
<span class="token comment">//</span>
<span class="token comment">// 1. the nonce of the message caller is correct</span>
<span class="token comment">// 2. caller has enough balance to cover transaction fee(gaslimit * gasprice)</span>
<span class="token comment">// 3. the amount of gas required is available in the block</span>
<span class="token comment">// 4. the purchased gas is enough to cover intrinsic usage</span>
<span class="token comment">// 5. there is no overflow when calculating intrinsic gas</span>
<span class="token comment">// 6. caller has enough balance to cover asset transfer for **topmost** call</span>
<span class="token comment">//</span>
<span class="token comment">// The preprocessing steps performed by the AnteHandler are:</span>
<span class="token comment">//</span>
<span class="token comment">// 1. set up the initial access list (iff fork &gt; Berlin)</span>
<span class="token comment">//</span>
<span class="token comment">// Query mode</span>
<span class="token comment">//</span>
<span class="token comment">// The gRPC query endpoint from 'eth_call' calls this method in query mode, and since the query handler don't call AnteHandler,</span>
<span class="token comment">// so we don't do real gas refund in that case.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>k <span class="token operator">*</span>Keeper<span class="token punctuation">)</span> <span class="token function">ApplyMessage</span><span class="token punctuation">(</span>evm <span class="token operator">*</span>vm<span class="token punctuation">.</span>EVM<span class="token punctuation">,</span> msg core<span class="token punctuation">.</span>Message<span class="token punctuation">,</span> cfg <span class="token operator">*</span>params<span class="token punctuation">.</span>ChainConfig<span class="token punctuation">,</span> query <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>types<span class="token punctuation">.</span>MsgEthereumTxResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> <span class="token punctuation">(</span>
		ret   <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span> <span class="token comment">// return bytes from evm execution</span>
		vmErr <span class="token builtin">error</span>  <span class="token comment">// vm errors do not effect consensus and are therefore not assigned to err</span>
	<span class="token punctuation">)</span>
	sender <span class="token operator">:=</span> vm<span class="token punctuation">.</span><span class="token function">AccountRef</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">From</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	contractCreation <span class="token operator">:=</span> msg<span class="token punctuation">.</span><span class="token function">To</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">nil</span>
	intrinsicGas<span class="token punctuation">,</span> err <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token function">GetEthIntrinsicGas</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> cfg<span class="token punctuation">,</span> contractCreation<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token comment">// should have already been checked on Ante Handler</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> stacktrace<span class="token punctuation">.</span><span class="token function">Propagate</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">&quot;intrinsic gas failed&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// Should check again even if it is checked on Ante Handler, because eth_call don't go through Ante Handler.</span>
	<span class="token keyword">if</span> msg<span class="token punctuation">.</span><span class="token function">Gas</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> intrinsicGas <span class="token punctuation">{</span>
		<span class="token comment">// eth_estimateGas will check for this exact error</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> stacktrace<span class="token punctuation">.</span><span class="token function">Propagate</span><span class="token punctuation">(</span>core<span class="token punctuation">.</span>ErrIntrinsicGas<span class="token punctuation">,</span> <span class="token string">&quot;apply message&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	leftoverGas <span class="token operator">:=</span> msg<span class="token punctuation">.</span><span class="token function">Gas</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> intrinsicGas
	<span class="token keyword">if</span> contractCreation <span class="token punctuation">{</span>
		ret<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> leftoverGas<span class="token punctuation">,</span> vmErr <span class="token operator">=</span> evm<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>sender<span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">Data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> leftoverGas<span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">Value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		ret<span class="token punctuation">,</span> leftoverGas<span class="token punctuation">,</span> vmErr <span class="token operator">=</span> evm<span class="token punctuation">.</span><span class="token function">Call</span><span class="token punctuation">(</span>sender<span class="token punctuation">,</span> <span class="token operator">*</span>msg<span class="token punctuation">.</span><span class="token function">To</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">Data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> leftoverGas<span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">Value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> query <span class="token punctuation">{</span>
		<span class="token comment">// gRPC query handlers don't go through the AnteHandler to deduct the gas fee from the sender or have access historical state.</span>
		<span class="token comment">// We don't refund gas to the sender.</span>
		<span class="token comment">// For more info, see: https://github.com/tharsis/ethermint/issues/229 and https://github.com/cosmos/cosmos-sdk/issues/9636</span>
		leftoverGas <span class="token operator">+=</span> k<span class="token punctuation">.</span><span class="token function">GasToRefund</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">Gas</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> leftoverGas<span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token comment">// refund gas prior to handling the vm error in order to match the Ethereum gas consumption instead of the default SDK one.</span>
		leftoverGas<span class="token punctuation">,</span> err <span class="token operator">=</span> k<span class="token punctuation">.</span><span class="token function">RefundGas</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> leftoverGas<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> stacktrace<span class="token punctuation">.</span><span class="token function">Propagate</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">&quot;failed to refund gas leftover gas to sender %s&quot;</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">From</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// EVM execution error needs to be available for the JSON-RPC client</span>
	<span class="token keyword">var</span> vmError <span class="token builtin">string</span>
	<span class="token keyword">if</span> vmErr <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		vmError <span class="token operator">=</span> vmErr<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	gasUsed <span class="token operator">:=</span> msg<span class="token punctuation">.</span><span class="token function">Gas</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> leftoverGas
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>types<span class="token punctuation">.</span>MsgEthereumTxResponse<span class="token punctuation">{</span>
		GasUsed<span class="token punctuation">:</span> gasUsed<span class="token punctuation">,</span>
		VmError<span class="token punctuation">:</span> vmError<span class="token punctuation">,</span>
		Ret<span class="token punctuation">:</span>     ret<span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
<span class="token comment">// GetEthIntrinsicGas returns the intrinsic gas cost for the transaction</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>k <span class="token operator">*</span>Keeper<span class="token punctuation">)</span> <span class="token function">GetEthIntrinsicGas</span><span class="token punctuation">(</span>msg core<span class="token punctuation">.</span>Message<span class="token punctuation">,</span> cfg <span class="token operator">*</span>params<span class="token punctuation">.</span>ChainConfig<span class="token punctuation">,</span> isContractCreation <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">uint64</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	height <span class="token operator">:=</span> big<span class="token punctuation">.</span><span class="token function">NewInt</span><span class="token punctuation">(</span>k<span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">BlockHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	homestead <span class="token operator">:=</span> cfg<span class="token punctuation">.</span><span class="token function">IsHomestead</span><span class="token punctuation">(</span>height<span class="token punctuation">)</span>
	istanbul <span class="token operator">:=</span> cfg<span class="token punctuation">.</span><span class="token function">IsIstanbul</span><span class="token punctuation">(</span>height<span class="token punctuation">)</span>
	<span class="token keyword">return</span> core<span class="token punctuation">.</span><span class="token function">IntrinsicGas</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">Data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">AccessList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> isContractCreation<span class="token punctuation">,</span> homestead<span class="token punctuation">,</span> istanbul<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// GasToRefund calculates the amount of gas the state machine should refund to the sender. It is</span>
<span class="token comment">// capped by half of the gas consumed.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>k <span class="token operator">*</span>Keeper<span class="token punctuation">)</span> <span class="token function">GasToRefund</span><span class="token punctuation">(</span>gasConsumed <span class="token builtin">uint64</span><span class="token punctuation">)</span> <span class="token builtin">uint64</span> <span class="token punctuation">{</span>
	<span class="token comment">// Apply refund counter, capped to half of the used gas.</span>
	refund <span class="token operator">:=</span> gasConsumed <span class="token operator">/</span> <span class="token number">2</span>
	availableRefund <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token function">GetRefund</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> refund <span class="token operator">&gt;</span> availableRefund <span class="token punctuation">{</span>
		<span class="token keyword">return</span> availableRefund
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> refund
<span class="token punctuation">}</span>
<span class="token comment">// RefundGas transfers the leftover gas to the sender of the message, caped to half of the total gas</span>
<span class="token comment">// consumed in the transaction. Additionally, the function sets the total gas consumed to the value</span>
<span class="token comment">// returned by the EVM execution, thus ignoring the previous intrinsic gas consumed during in the</span>
<span class="token comment">// AnteHandler.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>k <span class="token operator">*</span>Keeper<span class="token punctuation">)</span> <span class="token function">RefundGas</span><span class="token punctuation">(</span>msg core<span class="token punctuation">.</span>Message<span class="token punctuation">,</span> leftoverGas <span class="token builtin">uint64</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">uint64</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// safety check: leftover gas after execution should never exceed the gas limit defined on the message</span>
	<span class="token keyword">if</span> leftoverGas <span class="token operator">&gt;</span> msg<span class="token punctuation">.</span><span class="token function">Gas</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> leftoverGas<span class="token punctuation">,</span> stacktrace<span class="token punctuation">.</span><span class="token function">Propagate</span><span class="token punctuation">(</span>
			sdkerrors<span class="token punctuation">.</span><span class="token function">Wrapf</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span>ErrInconsistentGas<span class="token punctuation">,</span> <span class="token string">&quot;leftover gas cannot be greater than gas limit (%d &gt; %d)&quot;</span><span class="token punctuation">,</span> leftoverGas<span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">Gas</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			<span class="token string">&quot;failed to update gas consumed after refund of leftover gas&quot;</span><span class="token punctuation">,</span>
		<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	gasConsumed <span class="token operator">:=</span> msg<span class="token punctuation">.</span><span class="token function">Gas</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> leftoverGas
	<span class="token comment">// calculate available gas to refund and add it to the leftover gas amount</span>
	refund <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token function">GasToRefund</span><span class="token punctuation">(</span>gasConsumed<span class="token punctuation">)</span>
	leftoverGas <span class="token operator">+=</span> refund
	<span class="token comment">// safety check: leftover gas after refund should never exceed the gas limit defined on the message</span>
	<span class="token keyword">if</span> leftoverGas <span class="token operator">&gt;</span> msg<span class="token punctuation">.</span><span class="token function">Gas</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> leftoverGas<span class="token punctuation">,</span> stacktrace<span class="token punctuation">.</span><span class="token function">Propagate</span><span class="token punctuation">(</span>
			sdkerrors<span class="token punctuation">.</span><span class="token function">Wrapf</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span>ErrInconsistentGas<span class="token punctuation">,</span> <span class="token string">&quot;leftover gas cannot be greater than gas limit (%d &gt; %d)&quot;</span><span class="token punctuation">,</span> leftoverGas<span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">Gas</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			<span class="token string">&quot;failed to update gas consumed after refund of %d gas&quot;</span><span class="token punctuation">,</span> refund<span class="token punctuation">,</span>
		<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// Return EVM tokens for remaining gas, exchanged at the original rate.</span>
	remaining <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>big<span class="token punctuation">.</span>Int<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Mul</span><span class="token punctuation">(</span><span class="token function">new</span><span class="token punctuation">(</span>big<span class="token punctuation">.</span>Int<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">SetUint64</span><span class="token punctuation">(</span>leftoverGas<span class="token punctuation">)</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">GasPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">switch</span> remaining<span class="token punctuation">.</span><span class="token function">Sign</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">case</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>
		<span class="token comment">// negative refund errors</span>
		<span class="token keyword">return</span> leftoverGas<span class="token punctuation">,</span> sdkerrors<span class="token punctuation">.</span><span class="token function">Wrapf</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span>ErrInvalidRefund<span class="token punctuation">,</span> <span class="token string">&quot;refunded amount value cannot be negative %d&quot;</span><span class="token punctuation">,</span> remaining<span class="token punctuation">.</span><span class="token function">Int64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">case</span> <span class="token number">1</span><span class="token punctuation">:</span>
		<span class="token comment">// positive amount refund</span>
		params <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token function">GetParams</span><span class="token punctuation">(</span>k<span class="token punctuation">.</span>ctx<span class="token punctuation">)</span>
		refundedCoins <span class="token operator">:=</span> sdk<span class="token punctuation">.</span>Coins<span class="token punctuation">{</span>sdk<span class="token punctuation">.</span><span class="token function">NewCoin</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span>EvmDenom<span class="token punctuation">,</span> sdk<span class="token punctuation">.</span><span class="token function">NewIntFromBigInt</span><span class="token punctuation">(</span>remaining<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
		<span class="token comment">// refund to sender from the fee collector module account, which is the escrow account in charge of collecting tx fees</span>
		err <span class="token operator">:=</span> k<span class="token punctuation">.</span>bankKeeper<span class="token punctuation">.</span><span class="token function">SendCoinsFromModuleToAccount</span><span class="token punctuation">(</span>k<span class="token punctuation">.</span>ctx<span class="token punctuation">,</span> authtypes<span class="token punctuation">.</span>FeeCollectorName<span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">From</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> refundedCoins<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			err <span class="token operator">=</span> sdkerrors<span class="token punctuation">.</span><span class="token function">Wrapf</span><span class="token punctuation">(</span>sdkerrors<span class="token punctuation">.</span>ErrInsufficientFunds<span class="token punctuation">,</span> <span class="token string">&quot;fee collector account failed to refund fees: %s&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> leftoverGas<span class="token punctuation">,</span> stacktrace<span class="token punctuation">.</span><span class="token function">Propagate</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">&quot;failed to refund %d leftover gas (%s)&quot;</span><span class="token punctuation">,</span> leftoverGas<span class="token punctuation">,</span> refundedCoins<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token keyword">default</span><span class="token punctuation">:</span>
		<span class="token comment">// no refund, consume gas and update the tx gas meter</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> leftoverGas<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
<span class="token comment">// resetGasMeterAndConsumeGas reset first the gas meter consumed value to zero and set it back to the new value</span>
<span class="token comment">// 'gasUsed'</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>k <span class="token operator">*</span>Keeper<span class="token punctuation">)</span> <span class="token function">resetGasMeterAndConsumeGas</span><span class="token punctuation">(</span>gasUsed <span class="token builtin">uint64</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// reset the gas count</span>
	k<span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">GasMeter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">RefundGas</span><span class="token punctuation">(</span>k<span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">GasMeter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GasConsumed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;reset the gas count&quot;</span><span class="token punctuation">)</span>
	k<span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">GasMeter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ConsumeGas</span><span class="token punctuation">(</span>gasUsed<span class="token punctuation">,</span> <span class="token string">&quot;apply evm transaction&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// GetCoinbaseAddress returns the block proposer's validator operator address.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>k Keeper<span class="token punctuation">)</span> <span class="token function">GetCoinbaseAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>common<span class="token punctuation">.</span>Address<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	consAddr <span class="token operator">:=</span> sdk<span class="token punctuation">.</span><span class="token function">ConsAddress</span><span class="token punctuation">(</span>k<span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">BlockHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ProposerAddress<span class="token punctuation">)</span>
	validator<span class="token punctuation">,</span> found <span class="token operator">:=</span> k<span class="token punctuation">.</span>stakingKeeper<span class="token punctuation">.</span><span class="token function">GetValidatorByConsAddr</span><span class="token punctuation">(</span>k<span class="token punctuation">.</span>ctx<span class="token punctuation">,</span> consAddr<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>found <span class="token punctuation">{</span>
		<span class="token keyword">return</span> common<span class="token punctuation">.</span>Address<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> stacktrace<span class="token punctuation">.</span><span class="token function">Propagate</span><span class="token punctuation">(</span>
			sdkerrors<span class="token punctuation">.</span><span class="token function">Wrap</span><span class="token punctuation">(</span>stakingtypes<span class="token punctuation">.</span>ErrNoValidatorFound<span class="token punctuation">,</span> consAddr<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			<span class="token string">&quot;failed to retrieve validator from block proposer address&quot;</span><span class="token punctuation">,</span>
		<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	coinbase <span class="token operator">:=</span> common<span class="token punctuation">.</span><span class="token function">BytesToAddress</span><span class="token punctuation">(</span>validator<span class="token punctuation">.</span><span class="token function">GetOperator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> coinbase<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="antehandler"><a href="#antehandler" class="header-anchor">#</a> <code>AnteHandler</code></h4> <p>The Cosmos SDK <a href="https://docs.cosmos.network/main/basics/gas-fees.html#antehandler" target="_blank" rel="noopener noreferrer">AnteHandler<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> performs basic checks prior to transaction execution. These checks are usually signature verification, transaction field validation, transaction fees, etc.</p> <p>Regarding gas consumption and fees, the <code>AnteHandler</code> checks that the user has enough balance to cover for the tx cost (amount plus fees) as well as checking that the gas limit defined in the message is greater or equal than the computed intrinsic gas for the message.</p> <h3 id="gas-refunds"><a href="#gas-refunds" class="header-anchor">#</a> Gas Refunds</h3> <p>In the EVM, gas can be specified prior to execution. The totality of the gas specified is consumed at the beginning of the execution (during the AnteHandler step) and the remaining gas is refunded back to the user if any gas is left over after the execution. Additionally the EVM can also define gas to be refunded back to the user but those will be capped to a fraction of the used gas depending on the fork/version being used.</p> <h3 id="_0-fee-transactions"><a href="#_0-fee-transactions" class="header-anchor">#</a> 0 Fee Transactions</h3> <p>In Cosmos, a minimum gas price is not enforced by the AnteHandler as the min-gas-prices is checked against the local node/validator. In other words, the minimum fees accepted are determined by the validators of the network, and each validator can specify a different minimum value for their fees. This potentially allows end users to submit 0 fee transactions if there is at least one single validator that is willing to include transactions with 0 gas price in their blocks proposed.</p> <p>For this same reason, in Evmos it is possible to send transactions with 0 fees for transaction types other than the ones defined by the evm module. EVM module transactions cannot have 0 fees as gas is required inherently by the EVM. This check is done by the EVM transactions stateless validation (i.e ValidateBasic) function as well as on the custom AnteHandler defined by Evmos.</p> <h3 id="gas-estimation"><a href="#gas-estimation" class="header-anchor">#</a> Gas estimation</h3> <p>Ethereum provides a JSON-RPC endpoint eth_estimateGas to help users set up a correct gas limit in their transactions.</p> <p>Unfortunately, we cannot make use of the SDK tx simulation for gas estimation because the pre-check in the Ante Handlers would require a valid signature, and the sender balance to be enough to pay for the gas. But in Ethereum, this endpoint can be called without specifying any sender address.</p> <p>For that reason, a specific query API EstimateGas is implemented in Evmos. It will apply the transaction against the current block/state and perform a binary search in order to find the optimal gas value to return to the user (the same transaction will be applied over and over until we find the minimum gas needed before it fails). The reason we need to use a binary search is that the gas required for the transaction might be higher than the value returned by the EVM after applying the transaction, so we need to try until we find the optimal value.</p> <p>A cache context will be used during the whole execution to avoid changes be persisted in the state.</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> keeper
<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;context&quot;</span>
	<span class="token string">&quot;encoding/json&quot;</span>
	<span class="token string">&quot;errors&quot;</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;github.com/palantir/stacktrace&quot;</span>
	<span class="token string">&quot;google.golang.org/grpc/codes&quot;</span>
	<span class="token string">&quot;google.golang.org/grpc/status&quot;</span>
	<span class="token string">&quot;github.com/cosmos/cosmos-sdk/store/prefix&quot;</span>
	sdk <span class="token string">&quot;github.com/cosmos/cosmos-sdk/types&quot;</span>
	sdkerrors <span class="token string">&quot;github.com/cosmos/cosmos-sdk/types/errors&quot;</span>
	<span class="token string">&quot;github.com/cosmos/cosmos-sdk/types/query&quot;</span>
	ethcmn <span class="token string">&quot;github.com/ethereum/go-ethereum/common&quot;</span>
	<span class="token string">&quot;github.com/ethereum/go-ethereum/common/hexutil&quot;</span>
	<span class="token string">&quot;github.com/ethereum/go-ethereum/core&quot;</span>
	ethtypes <span class="token string">&quot;github.com/ethereum/go-ethereum/core/types&quot;</span>
	<span class="token string">&quot;github.com/ethereum/go-ethereum/core/vm&quot;</span>
	ethparams <span class="token string">&quot;github.com/ethereum/go-ethereum/params&quot;</span>
	ethermint <span class="token string">&quot;github.com/tharsis/ethermint/types&quot;</span>
	<span class="token string">&quot;github.com/tharsis/ethermint/x/evm/types&quot;</span>
<span class="token punctuation">)</span>
<span class="token keyword">var</span> <span class="token boolean">_</span> types<span class="token punctuation">.</span>QueryServer <span class="token operator">=</span> Keeper<span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token comment">// Account implements the Query/Account gRPC method</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>k Keeper<span class="token punctuation">)</span> <span class="token function">Account</span><span class="token punctuation">(</span>c context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> req <span class="token operator">*</span>types<span class="token punctuation">.</span>QueryAccountRequest<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>types<span class="token punctuation">.</span>QueryAccountResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> req <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>InvalidArgument<span class="token punctuation">,</span> <span class="token string">&quot;empty request&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> ethermint<span class="token punctuation">.</span><span class="token function">ValidateAddress</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>Address<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>
			codes<span class="token punctuation">.</span>InvalidArgument<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	addr <span class="token operator">:=</span> ethcmn<span class="token punctuation">.</span><span class="token function">HexToAddress</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>Address<span class="token punctuation">)</span>
	ctx <span class="token operator">:=</span> sdk<span class="token punctuation">.</span><span class="token function">UnwrapSDKContext</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
	k<span class="token punctuation">.</span><span class="token function">WithContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>types<span class="token punctuation">.</span>QueryAccountResponse<span class="token punctuation">{</span>
		Balance<span class="token punctuation">:</span>  k<span class="token punctuation">.</span><span class="token function">GetBalance</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		CodeHash<span class="token punctuation">:</span> k<span class="token punctuation">.</span><span class="token function">GetCodeHash</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		Nonce<span class="token punctuation">:</span>    k<span class="token punctuation">.</span><span class="token function">GetNonce</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>k Keeper<span class="token punctuation">)</span> <span class="token function">CosmosAccount</span><span class="token punctuation">(</span>c context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> req <span class="token operator">*</span>types<span class="token punctuation">.</span>QueryCosmosAccountRequest<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>types<span class="token punctuation">.</span>QueryCosmosAccountResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> req <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>InvalidArgument<span class="token punctuation">,</span> <span class="token string">&quot;empty request&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> ethermint<span class="token punctuation">.</span><span class="token function">ValidateAddress</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>Address<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>
			codes<span class="token punctuation">.</span>InvalidArgument<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	ctx <span class="token operator">:=</span> sdk<span class="token punctuation">.</span><span class="token function">UnwrapSDKContext</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
	k<span class="token punctuation">.</span><span class="token function">WithContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
	ethAddr <span class="token operator">:=</span> ethcmn<span class="token punctuation">.</span><span class="token function">HexToAddress</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>Address<span class="token punctuation">)</span>
	cosmosAddr <span class="token operator">:=</span> sdk<span class="token punctuation">.</span><span class="token function">AccAddress</span><span class="token punctuation">(</span>ethAddr<span class="token punctuation">.</span><span class="token function">Bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	account <span class="token operator">:=</span> k<span class="token punctuation">.</span>accountKeeper<span class="token punctuation">.</span><span class="token function">GetAccount</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> cosmosAddr<span class="token punctuation">)</span>
	res <span class="token operator">:=</span> types<span class="token punctuation">.</span>QueryCosmosAccountResponse<span class="token punctuation">{</span>
		CosmosAddress<span class="token punctuation">:</span> cosmosAddr<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> account <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		res<span class="token punctuation">.</span>Sequence <span class="token operator">=</span> account<span class="token punctuation">.</span><span class="token function">GetSequence</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		res<span class="token punctuation">.</span>AccountNumber <span class="token operator">=</span> account<span class="token punctuation">.</span><span class="token function">GetAccountNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>res<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>k Keeper<span class="token punctuation">)</span> <span class="token function">ValidatorAccount</span><span class="token punctuation">(</span>c context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> req <span class="token operator">*</span>types<span class="token punctuation">.</span>QueryValidatorAccountRequest<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>types<span class="token punctuation">.</span>QueryValidatorAccountResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> req <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>InvalidArgument<span class="token punctuation">,</span> <span class="token string">&quot;empty request&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	consAddr<span class="token punctuation">,</span> err <span class="token operator">:=</span> sdk<span class="token punctuation">.</span><span class="token function">ConsAddressFromBech32</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>ConsAddress<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>
			codes<span class="token punctuation">.</span>InvalidArgument<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	ctx <span class="token operator">:=</span> sdk<span class="token punctuation">.</span><span class="token function">UnwrapSDKContext</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
	k<span class="token punctuation">.</span><span class="token function">WithContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
	validator<span class="token punctuation">,</span> found <span class="token operator">:=</span> k<span class="token punctuation">.</span>stakingKeeper<span class="token punctuation">.</span><span class="token function">GetValidatorByConsAddr</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> consAddr<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>found <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>
	accAddr <span class="token operator">:=</span> sdk<span class="token punctuation">.</span><span class="token function">AccAddress</span><span class="token punctuation">(</span>validator<span class="token punctuation">.</span><span class="token function">GetOperator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	res <span class="token operator">:=</span> types<span class="token punctuation">.</span>QueryValidatorAccountResponse<span class="token punctuation">{</span>
		AccountAddress<span class="token punctuation">:</span> accAddr<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	account <span class="token operator">:=</span> k<span class="token punctuation">.</span>accountKeeper<span class="token punctuation">.</span><span class="token function">GetAccount</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> accAddr<span class="token punctuation">)</span>
	<span class="token keyword">if</span> account <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		res<span class="token punctuation">.</span>Sequence <span class="token operator">=</span> account<span class="token punctuation">.</span><span class="token function">GetSequence</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		res<span class="token punctuation">.</span>AccountNumber <span class="token operator">=</span> account<span class="token punctuation">.</span><span class="token function">GetAccountNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>res<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
<span class="token comment">// Balance implements the Query/Balance gRPC method</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>k Keeper<span class="token punctuation">)</span> <span class="token function">Balance</span><span class="token punctuation">(</span>c context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> req <span class="token operator">*</span>types<span class="token punctuation">.</span>QueryBalanceRequest<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>types<span class="token punctuation">.</span>QueryBalanceResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> req <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>InvalidArgument<span class="token punctuation">,</span> <span class="token string">&quot;empty request&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> ethermint<span class="token punctuation">.</span><span class="token function">ValidateAddress</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>Address<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>
			codes<span class="token punctuation">.</span>InvalidArgument<span class="token punctuation">,</span>
			types<span class="token punctuation">.</span>ErrZeroAddress<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	ctx <span class="token operator">:=</span> sdk<span class="token punctuation">.</span><span class="token function">UnwrapSDKContext</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
	k<span class="token punctuation">.</span><span class="token function">WithContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
	balanceInt <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token function">GetBalance</span><span class="token punctuation">(</span>ethcmn<span class="token punctuation">.</span><span class="token function">HexToAddress</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>Address<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>types<span class="token punctuation">.</span>QueryBalanceResponse<span class="token punctuation">{</span>
		Balance<span class="token punctuation">:</span> balanceInt<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
<span class="token comment">// Storage implements the Query/Storage gRPC method</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>k Keeper<span class="token punctuation">)</span> <span class="token function">Storage</span><span class="token punctuation">(</span>c context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> req <span class="token operator">*</span>types<span class="token punctuation">.</span>QueryStorageRequest<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>types<span class="token punctuation">.</span>QueryStorageResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> req <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>InvalidArgument<span class="token punctuation">,</span> <span class="token string">&quot;empty request&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> ethermint<span class="token punctuation">.</span><span class="token function">ValidateAddress</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>Address<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>
			codes<span class="token punctuation">.</span>InvalidArgument<span class="token punctuation">,</span>
			types<span class="token punctuation">.</span>ErrZeroAddress<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	ctx <span class="token operator">:=</span> sdk<span class="token punctuation">.</span><span class="token function">UnwrapSDKContext</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
	k<span class="token punctuation">.</span><span class="token function">WithContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
	address <span class="token operator">:=</span> ethcmn<span class="token punctuation">.</span><span class="token function">HexToAddress</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>Address<span class="token punctuation">)</span>
	key <span class="token operator">:=</span> ethcmn<span class="token punctuation">.</span><span class="token function">HexToHash</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>Key<span class="token punctuation">)</span>
	state <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token function">GetState</span><span class="token punctuation">(</span>address<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
	stateHex <span class="token operator">:=</span> state<span class="token punctuation">.</span><span class="token function">Hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>types<span class="token punctuation">.</span>QueryStorageResponse<span class="token punctuation">{</span>
		Value<span class="token punctuation">:</span> stateHex<span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
<span class="token comment">// Code implements the Query/Code gRPC method</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>k Keeper<span class="token punctuation">)</span> <span class="token function">Code</span><span class="token punctuation">(</span>c context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> req <span class="token operator">*</span>types<span class="token punctuation">.</span>QueryCodeRequest<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>types<span class="token punctuation">.</span>QueryCodeResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> req <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>InvalidArgument<span class="token punctuation">,</span> <span class="token string">&quot;empty request&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> ethermint<span class="token punctuation">.</span><span class="token function">ValidateAddress</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>Address<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>
			codes<span class="token punctuation">.</span>InvalidArgument<span class="token punctuation">,</span>
			types<span class="token punctuation">.</span>ErrZeroAddress<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	ctx <span class="token operator">:=</span> sdk<span class="token punctuation">.</span><span class="token function">UnwrapSDKContext</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
	k<span class="token punctuation">.</span><span class="token function">WithContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
	address <span class="token operator">:=</span> ethcmn<span class="token punctuation">.</span><span class="token function">HexToAddress</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>Address<span class="token punctuation">)</span>
	code <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token function">GetCode</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>types<span class="token punctuation">.</span>QueryCodeResponse<span class="token punctuation">{</span>
		Code<span class="token punctuation">:</span> code<span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
<span class="token comment">// TxLogs implements the Query/TxLogs gRPC method</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>k Keeper<span class="token punctuation">)</span> <span class="token function">TxLogs</span><span class="token punctuation">(</span>c context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> req <span class="token operator">*</span>types<span class="token punctuation">.</span>QueryTxLogsRequest<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>types<span class="token punctuation">.</span>QueryTxLogsResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> req <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>InvalidArgument<span class="token punctuation">,</span> <span class="token string">&quot;empty request&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> ethermint<span class="token punctuation">.</span><span class="token function">IsEmptyHash</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>Hash<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>
			codes<span class="token punctuation">.</span>InvalidArgument<span class="token punctuation">,</span>
			types<span class="token punctuation">.</span>ErrEmptyHash<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	ctx <span class="token operator">:=</span> sdk<span class="token punctuation">.</span><span class="token function">UnwrapSDKContext</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
	k<span class="token punctuation">.</span><span class="token function">WithContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
	hash <span class="token operator">:=</span> ethcmn<span class="token punctuation">.</span><span class="token function">HexToHash</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>Hash<span class="token punctuation">)</span>
	logs <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token function">GetTxLogs</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>types<span class="token punctuation">.</span>QueryTxLogsResponse<span class="token punctuation">{</span>
		Logs<span class="token punctuation">:</span> types<span class="token punctuation">.</span><span class="token function">NewLogsFromEth</span><span class="token punctuation">(</span>logs<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
<span class="token comment">// BlockLogs implements the Query/BlockLogs gRPC method</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>k Keeper<span class="token punctuation">)</span> <span class="token function">BlockLogs</span><span class="token punctuation">(</span>c context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> req <span class="token operator">*</span>types<span class="token punctuation">.</span>QueryBlockLogsRequest<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>types<span class="token punctuation">.</span>QueryBlockLogsResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> req <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>InvalidArgument<span class="token punctuation">,</span> <span class="token string">&quot;empty request&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> ethermint<span class="token punctuation">.</span><span class="token function">IsEmptyHash</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>Hash<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>
			codes<span class="token punctuation">.</span>InvalidArgument<span class="token punctuation">,</span>
			types<span class="token punctuation">.</span>ErrEmptyHash<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	ctx <span class="token operator">:=</span> sdk<span class="token punctuation">.</span><span class="token function">UnwrapSDKContext</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
	store <span class="token operator">:=</span> prefix<span class="token punctuation">.</span><span class="token function">NewStore</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">KVStore</span><span class="token punctuation">(</span>k<span class="token punctuation">.</span>storeKey<span class="token punctuation">)</span><span class="token punctuation">,</span> types<span class="token punctuation">.</span>KeyPrefixLogs<span class="token punctuation">)</span>
	txLogs <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>types<span class="token punctuation">.</span>TransactionLogs<span class="token punctuation">{</span><span class="token punctuation">}</span>
	pageRes<span class="token punctuation">,</span> err <span class="token operator">:=</span> query<span class="token punctuation">.</span><span class="token function">FilteredPaginate</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> req<span class="token punctuation">.</span>Pagination<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token boolean">_</span><span class="token punctuation">,</span> value <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> accumulate <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">var</span> txLog types<span class="token punctuation">.</span>TransactionLogs
		k<span class="token punctuation">.</span>cdc<span class="token punctuation">.</span><span class="token function">MustUnmarshal</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token operator">&amp;</span>txLog<span class="token punctuation">)</span>
		<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>txLog<span class="token punctuation">.</span>Logs<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> txLog<span class="token punctuation">.</span>Logs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>BlockHash <span class="token operator">==</span> req<span class="token punctuation">.</span>Hash <span class="token punctuation">{</span>
			<span class="token keyword">if</span> accumulate <span class="token punctuation">{</span>
				txLogs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>txLogs<span class="token punctuation">,</span> txLog<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>Internal<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>types<span class="token punctuation">.</span>QueryBlockLogsResponse<span class="token punctuation">{</span>
		TxLogs<span class="token punctuation">:</span>     txLogs<span class="token punctuation">,</span>
		Pagination<span class="token punctuation">:</span> pageRes<span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
<span class="token comment">// BlockBloom implements the Query/BlockBloom gRPC method</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>k Keeper<span class="token punctuation">)</span> <span class="token function">BlockBloom</span><span class="token punctuation">(</span>c context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> req <span class="token operator">*</span>types<span class="token punctuation">.</span>QueryBlockBloomRequest<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>types<span class="token punctuation">.</span>QueryBlockBloomResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	ctx <span class="token operator">:=</span> sdk<span class="token punctuation">.</span><span class="token function">UnwrapSDKContext</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
	bloom<span class="token punctuation">,</span> found <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token function">GetBlockBloom</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> req<span class="token punctuation">.</span>Height<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>found <span class="token punctuation">{</span>
		<span class="token comment">// if the bloom is not found, query the transient store at the current height</span>
		k<span class="token punctuation">.</span>ctx <span class="token operator">=</span> ctx
		bloomInt <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token function">GetBlockBloomTransient</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> bloomInt<span class="token punctuation">.</span><span class="token function">Sign</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>
				codes<span class="token punctuation">.</span>NotFound<span class="token punctuation">,</span> sdkerrors<span class="token punctuation">.</span><span class="token function">Wrapf</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span>ErrBloomNotFound<span class="token punctuation">,</span> <span class="token string">&quot;height: %d&quot;</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>Height<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		bloom <span class="token operator">=</span> ethtypes<span class="token punctuation">.</span><span class="token function">BytesToBloom</span><span class="token punctuation">(</span>bloomInt<span class="token punctuation">.</span><span class="token function">Bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>types<span class="token punctuation">.</span>QueryBlockBloomResponse<span class="token punctuation">{</span>
		Bloom<span class="token punctuation">:</span> bloom<span class="token punctuation">.</span><span class="token function">Bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
<span class="token comment">// Params implements the Query/Params gRPC method</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>k Keeper<span class="token punctuation">)</span> <span class="token function">Params</span><span class="token punctuation">(</span>c context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">*</span>types<span class="token punctuation">.</span>QueryParamsRequest<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>types<span class="token punctuation">.</span>QueryParamsResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	ctx <span class="token operator">:=</span> sdk<span class="token punctuation">.</span><span class="token function">UnwrapSDKContext</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
	params <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token function">GetParams</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>types<span class="token punctuation">.</span>QueryParamsResponse<span class="token punctuation">{</span>
		Params<span class="token punctuation">:</span> params<span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
<span class="token comment">// StaticCall implements Query/StaticCall gRPCP method</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>k Keeper<span class="token punctuation">)</span> <span class="token function">StaticCall</span><span class="token punctuation">(</span>c context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> req <span class="token operator">*</span>types<span class="token punctuation">.</span>QueryStaticCallRequest<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>types<span class="token punctuation">.</span>QueryStaticCallResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> req <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>InvalidArgument<span class="token punctuation">,</span> <span class="token string">&quot;empty request&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// ctx := sdk.UnwrapSDKContext(c)</span>
	<span class="token comment">// k.WithContext(ctx)</span>
	<span class="token comment">// // parse the chainID from a string to a base-10 integer</span>
	<span class="token comment">// chainIDEpoch, err := ethermint.ParseChainID(ctx.ChainID())</span>
	<span class="token comment">// if err != nil {</span>
	<span class="token comment">// 	return nil, status.Error(codes.Internal, err.Error())</span>
	<span class="token comment">// }</span>
	<span class="token comment">// txHash := tmtypes.Tx(ctx.TxBytes()).Hash()</span>
	<span class="token comment">// ethHash := ethcmn.BytesToHash(txHash)</span>
	<span class="token comment">// var recipient *ethcmn.Address</span>
	<span class="token comment">// if len(req.Address) &gt; 0 {</span>
	<span class="token comment">// 	addr := ethcmn.HexToAddress(req.Address)</span>
	<span class="token comment">// 	recipient = &amp;addr</span>
	<span class="token comment">// }</span>
	<span class="token comment">// so := k.GetOrNewStateObject(*recipient)</span>
	<span class="token comment">// sender := ethcmn.HexToAddress(&quot;0xaDd00275E3d9d213654Ce5223f0FADE8b106b707&quot;)</span>
	<span class="token comment">// msg := types.NewTx(</span>
	<span class="token comment">// 	chainIDEpoch, so.Nonce(), recipient, big.NewInt(0), 100000000, big.NewInt(0), req.Input, nil,</span>
	<span class="token comment">// )</span>
	<span class="token comment">// msg.From = sender.Hex()</span>
	<span class="token comment">// if err := msg.ValidateBasic(); err != nil {</span>
	<span class="token comment">// 	return nil, status.Error(codes.Internal, err.Error())</span>
	<span class="token comment">// }</span>
	<span class="token comment">// ethMsg, err := msg.AsMessage()</span>
	<span class="token comment">// if err != nil {</span>
	<span class="token comment">// 	return nil, status.Error(codes.Internal, err.Error())</span>
	<span class="token comment">// }</span>
	<span class="token comment">// st := &amp;types.StateTransition{</span>
	<span class="token comment">// 	Message:  ethMsg,</span>
	<span class="token comment">// 	Csdb:     k.WithContext(ctx),</span>
	<span class="token comment">// 	ChainID:  chainIDEpoch,</span>
	<span class="token comment">// 	TxHash:   &amp;ethHash,</span>
	<span class="token comment">// 	Simulate: ctx.IsCheckTx(),</span>
	<span class="token comment">// 	Debug:    false,</span>
	<span class="token comment">// }</span>
	<span class="token comment">// config, found := k.GetChainConfig(ctx)</span>
	<span class="token comment">// if !found {</span>
	<span class="token comment">// 	return nil, status.Error(codes.Internal, types.ErrChainConfigNotFound.Error())</span>
	<span class="token comment">// }</span>
	<span class="token comment">// ret, err := st.StaticCall(ctx, config)</span>
	<span class="token comment">// if err != nil {</span>
	<span class="token comment">// 	return nil, status.Error(codes.Internal, err.Error())</span>
	<span class="token comment">// }</span>
	<span class="token comment">// return &amp;types.QueryStaticCallResponse{Data: ret}, nil</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
<span class="token comment">// EthCall implements eth_call rpc api.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>k Keeper<span class="token punctuation">)</span> <span class="token function">EthCall</span><span class="token punctuation">(</span>c context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> req <span class="token operator">*</span>types<span class="token punctuation">.</span>EthCallRequest<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>types<span class="token punctuation">.</span>MsgEthereumTxResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	ctx <span class="token operator">:=</span> sdk<span class="token punctuation">.</span><span class="token function">UnwrapSDKContext</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
	k<span class="token punctuation">.</span><span class="token function">WithContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
	<span class="token keyword">var</span> args types<span class="token punctuation">.</span>CallArgs
	err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>Args<span class="token punctuation">,</span> <span class="token operator">&amp;</span>args<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>InvalidArgument<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	msg <span class="token operator">:=</span> args<span class="token punctuation">.</span><span class="token function">ToMessage</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>GasCap<span class="token punctuation">)</span>
	params <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token function">GetParams</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
	ethCfg <span class="token operator">:=</span> params<span class="token punctuation">.</span>ChainConfig<span class="token punctuation">.</span><span class="token function">EthereumConfig</span><span class="token punctuation">(</span>k<span class="token punctuation">.</span>eip155ChainID<span class="token punctuation">)</span>
	coinbase<span class="token punctuation">,</span> err <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token function">GetCoinbaseAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>Internal<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	evm <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token function">NewEVM</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> ethCfg<span class="token punctuation">,</span> params<span class="token punctuation">,</span> coinbase<span class="token punctuation">)</span>
	<span class="token comment">// pass true means execute in query mode, which don't do actual gas refund.</span>
	res<span class="token punctuation">,</span> err <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token function">ApplyMessage</span><span class="token punctuation">(</span>evm<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> ethCfg<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>Internal<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> res<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
<span class="token comment">// EstimateGas implements eth_estimateGas rpc api.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>k Keeper<span class="token punctuation">)</span> <span class="token function">EstimateGas</span><span class="token punctuation">(</span>c context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> req <span class="token operator">*</span>types<span class="token punctuation">.</span>EthCallRequest<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>types<span class="token punctuation">.</span>EstimateGasResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	ctx <span class="token operator">:=</span> sdk<span class="token punctuation">.</span><span class="token function">UnwrapSDKContext</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
	k<span class="token punctuation">.</span><span class="token function">WithContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
	<span class="token keyword">if</span> req<span class="token punctuation">.</span>GasCap <span class="token operator">&lt;</span> ethparams<span class="token punctuation">.</span>TxGas <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>InvalidArgument<span class="token punctuation">,</span> <span class="token string">&quot;gas cap cannot be lower than 21,000&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">var</span> args types<span class="token punctuation">.</span>CallArgs
	err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>Args<span class="token punctuation">,</span> <span class="token operator">&amp;</span>args<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>InvalidArgument<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// Binary search the gas requirement, as it may be higher than the amount used</span>
	<span class="token keyword">var</span> <span class="token punctuation">(</span>
		lo  <span class="token operator">=</span> ethparams<span class="token punctuation">.</span>TxGas <span class="token operator">-</span> <span class="token number">1</span>
		hi  <span class="token builtin">uint64</span>
		<span class="token builtin">cap</span> <span class="token builtin">uint64</span>
	<span class="token punctuation">)</span>
	<span class="token comment">// Determine the highest gas limit can be used during the estimation.</span>
	<span class="token keyword">if</span> args<span class="token punctuation">.</span>Gas <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> <span class="token function">uint64</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">.</span>Gas<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> ethparams<span class="token punctuation">.</span>TxGas <span class="token punctuation">{</span>
		hi <span class="token operator">=</span> <span class="token function">uint64</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">.</span>Gas<span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token comment">// Query block gas limit</span>
		params <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">ConsensusParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> params <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> params<span class="token punctuation">.</span>Block <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> params<span class="token punctuation">.</span>Block<span class="token punctuation">.</span>MaxGas <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
			hi <span class="token operator">=</span> <span class="token function">uint64</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span>Block<span class="token punctuation">.</span>MaxGas<span class="token punctuation">)</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			hi <span class="token operator">=</span> req<span class="token punctuation">.</span>GasCap
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// TODO Recap the highest gas limit with account's available balance.</span>
	<span class="token comment">// Recap the highest gas allowance with specified gascap.</span>
	<span class="token keyword">if</span> req<span class="token punctuation">.</span>GasCap <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> hi <span class="token operator">&gt;</span> req<span class="token punctuation">.</span>GasCap <span class="token punctuation">{</span>
		hi <span class="token operator">=</span> req<span class="token punctuation">.</span>GasCap
	<span class="token punctuation">}</span>
	<span class="token builtin">cap</span> <span class="token operator">=</span> hi
	params <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token function">GetParams</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
	ethCfg <span class="token operator">:=</span> params<span class="token punctuation">.</span>ChainConfig<span class="token punctuation">.</span><span class="token function">EthereumConfig</span><span class="token punctuation">(</span>k<span class="token punctuation">.</span>eip155ChainID<span class="token punctuation">)</span>
	coinbase<span class="token punctuation">,</span> err <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token function">GetCoinbaseAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>Internal<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// Create a helper to check if a gas allowance results in an executable transaction</span>
	executable <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>gas <span class="token builtin">uint64</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token operator">*</span>types<span class="token punctuation">.</span>MsgEthereumTxResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		args<span class="token punctuation">.</span>Gas <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>hexutil<span class="token punctuation">.</span>Uint64<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gas<span class="token punctuation">)</span>
		<span class="token comment">// Execute the call in an isolated context</span>
		k<span class="token punctuation">.</span><span class="token function">BeginCachedContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		msg <span class="token operator">:=</span> args<span class="token punctuation">.</span><span class="token function">ToMessage</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>GasCap<span class="token punctuation">)</span>
		evm <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token function">NewEVM</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> ethCfg<span class="token punctuation">,</span> params<span class="token punctuation">,</span> coinbase<span class="token punctuation">)</span>
		<span class="token comment">// pass true means execute in query mode, which don't do actual gas refund.</span>
		rsp<span class="token punctuation">,</span> err <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token function">ApplyMessage</span><span class="token punctuation">(</span>evm<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> ethCfg<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
		k<span class="token punctuation">.</span><span class="token function">EndCachedContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> errors<span class="token punctuation">.</span><span class="token function">Is</span><span class="token punctuation">(</span>stacktrace<span class="token punctuation">.</span><span class="token function">RootCause</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">,</span> core<span class="token punctuation">.</span>ErrIntrinsicGas<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span> <span class="token comment">// Special case, raise gas limit</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err <span class="token comment">// Bail out</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token function">len</span><span class="token punctuation">(</span>rsp<span class="token punctuation">.</span>VmError<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">,</span> rsp<span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// Execute the binary search and hone in on an executable gas limit</span>
	hi<span class="token punctuation">,</span> err <span class="token operator">=</span> types<span class="token punctuation">.</span><span class="token function">BinSearch</span><span class="token punctuation">(</span>lo<span class="token punctuation">,</span> hi<span class="token punctuation">,</span> executable<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>Internal<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// Reject the transaction as invalid if it still fails at the highest allowance</span>
	<span class="token keyword">if</span> hi <span class="token operator">==</span> <span class="token builtin">cap</span> <span class="token punctuation">{</span>
		failed<span class="token punctuation">,</span> result<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">executable</span><span class="token punctuation">(</span>hi<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>Internal<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> failed <span class="token punctuation">{</span>
			<span class="token keyword">if</span> result <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> result<span class="token punctuation">.</span>VmError <span class="token operator">!=</span> vm<span class="token punctuation">.</span>ErrOutOfGas<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">if</span> result<span class="token punctuation">.</span>VmError <span class="token operator">==</span> vm<span class="token punctuation">.</span>ErrExecutionReverted<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> types<span class="token punctuation">.</span><span class="token function">NewExecErrorWithReason</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>Ret<span class="token punctuation">)</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>Internal<span class="token punctuation">,</span> result<span class="token punctuation">.</span>VmError<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			<span class="token comment">// Otherwise, the specified gas cap is too low</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>Internal<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;gas required exceeds allowance (%d)&quot;</span><span class="token punctuation">,</span> <span class="token builtin">cap</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>types<span class="token punctuation">.</span>EstimateGasResponse<span class="token punctuation">{</span>Gas<span class="token punctuation">:</span> hi<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/meteos-labs/metaos-docs/edit/master/packages/docs/dist/en/for_web3_user/gas-and-fees.md" target="_blank" rel="noopener noreferrer">Edit this page on GitHub</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/docs/en/for_web3_user/tokens.html" class="prev">
        Tokens
      </a></span> <span class="next"><a href="/docs/en/for_web3_user/metamask.html">
        MetaMask
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/docs/assets/js/app.4c002d4e.js" defer></script><script src="/docs/assets/js/3.6a5372a7.js" defer></script><script src="/docs/assets/js/11.d2336c4a.js" defer></script><script src="/docs/assets/js/4.dad8f1e2.js" defer></script>
  </body>
</html>
